# Оценка эффективности нового ранжирования товаров в каталоге
**Суть задачи:** раз в месяц оцифровывать на уровне номенклатуры магазина (опционально - уровня SKU) изменения, на которые могут повлиять селлеры, а именно: качество контента в карточке товара, наличие, ценовой индекс.

**Метод:** раздельный экспорт в csv с агрегацией на уровне SQL-запросов из GreenPlum и ClickHouse с последующим сведением в итоговую таблицу Excel.

## Этап 0 - Подготовительный. Выгрузка средневзвешенных конверсий
Для каждой метрики (например, **CR из каталога в карточку товара**) вместо простого расчета конверсии вычисляется взвешенное среднее, где вес — это доля просмотров карточки товара (details) от общей суммы просмотров карточек товаров.
![расчет средневзвешенных просмотров PDP](https://github.com/v-khlyzov/new-ranking-assessment/blob/03190f5a9ec1a5f8386a4d4cf3793e9dbec41b22/images/%D1%80%D0%B0%D1%81%D1%87%D0%B5%D1%82%20%D1%81%D1%80%D0%B5%D0%B4%D0%BD%D0%B5%D0%B2%D0%B7%D0%B2%D0%B5%D1%88%D0%B5%D0%BD%D0%BD%D1%8B%D1%85%20%D0%BF%D1%80%D0%BE%D1%81%D0%BC%D0%BE%D1%82%D1%80%D0%BE%D0%B2%20PDP.png)

Выгружается из **ClickHouse** скриптом [Средневзвешенные конверсии.sql](https://github.com/v-khlyzov/new-ranking-assessment/blob/aaa8da09a2b64e0c367c5bed94fc15711045f333/sql-scripts/0.%20%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D0%B5%D0%B2%D0%B7%D0%B2%D0%B5%D1%88%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%BD%D0%B0%20pdp_views%20%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D0%BA%D0%B8.sql)

## Этап 1 - Скоринг количества фото товара по 8-балльной шкале

Оценка дается согласно количеству фото в карточке (но не более 8 шт.) через функцию LEAST()

Выгружается из **GreenPlum** скриптом [скоринг количества фото.sql](https://github.com/v-khlyzov/new-ranking-assessment/blob/aaa8da09a2b64e0c367c5bed94fc15711045f333/sql-scripts/1.%20%D1%81%D0%BA%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%20%D1%84%D0%BE%D1%82%D0%BE%208%20%D0%B1%D0%B0%D0%BB%D0%BB%D0%BE%D0%B2.sql)

## Этап 2 - Скоринг доступности товара по 14-балльной шкале

Если на уровне товарной номенклатуры нет ни одного SKU с доступностью, значит оценка = 0.

Выгружается из **GreenPlum** скриптом [скоринг доступности.sql](https://github.com/v-khlyzov/new-ranking-assessment/blob/aaa8da09a2b64e0c367c5bed94fc15711045f333/sql-scripts/3%20%D1%81%D0%BA%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%20%D0%BF%D0%BE%20%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D0%BE%D1%81%D1%82%D0%B8%2012%20%D0%B1%D0%B0%D0%BB%D0%BB%D0%BE%D0%B2.sql)

## Этап 3 - Скоринг ценового индекса (PI) товара по 12-балльной шкале

Минимальный PI к рынку **<= 0.95** (т.е. на +5% дешевле рынка) – это наивысшая оценка товара в 12 баллов, товары с **PI >= 1.20** (т.е. на +20% дороже рынка) - минимальная оценка в 1 балл.

Все, что в диапазоне между 0.95 и 1.20 - оценивается градиентом от 11 до 2 баллов. 

Если на уровне номенклатуры нет ни одного товара с установленным ценовым индексом, значит PI = 1 (по умолчанию считаем, что цена соответсвует рыночной), а рейтинг = 9.8.

Выгружается из **ClickHouse** скриптом [скоринг ценового индекса.sql](https://github.com/v-khlyzov/new-ranking-assessment/blob/aaa8da09a2b64e0c367c5bed94fc15711045f333/sql-scripts/1.%20%D1%81%D0%BA%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%20%D1%84%D0%BE%D1%82%D0%BE%208%20%D0%B1%D0%B0%D0%BB%D0%BB%D0%BE%D0%B2.sql](https://github.com/v-khlyzov/new-ranking-assessment/blob/aaa8da09a2b64e0c367c5bed94fc15711045f333/sql-scripts/2.%20%D1%81%D0%BA%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%20PI%2012%20%D0%B1%D0%B0%D0%BB%D0%BB%D0%BE%D0%B2.sql))

## Этап 4 - Расчет финальной оценки (по 5-балльной шкале)
Объединяем в единый файл 4 csv выгрузки из предыдущих пунктов.

Метрикам **avg_content_score** (количество фото), **avg_availability_score** (история наличия товаров), **avg_pi_score** (ценовой индекс) - назначаются веса по 1, 2 и 2 соответственно.

Каждая метрика нормализуется путем деления на свою максимальную оценку (8, 14 и 12 соответственно) и умножается на 5.

Каждый показатель умножается на свой вес (1, 2 и 2 соответственно), а результаты суммируются.

В итоге получается сводная таблица с текущей оценкой для связки (ключа) "тип ассортимента - раздел товарной номеклатуры", а также приводится для сравнения оценка, выставленная в предыдущий раз.

![Excel файл с 4 связками для примера](https://github.com/v-khlyzov/new-ranking-assessment/blob/76bd0164a2eb978feca00db590fdedd4bfe0d654/images/%D0%A1%D0%B2%D0%BE%D0%B4%D0%BD%D1%8B%D0%B9%20%D0%BE%D1%82%D1%87%D0%B5%D1%82%20%D0%BF%D0%BE%20%D1%80%D0%B0%D0%BD%D0%B6%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8E%20%D0%B2%20%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3%D0%B5.png)
[Excel файл с 4 связками для примера](https://onedrive.live.com/personal/312bded3bb6cfc05/_layouts/15/doc2.aspx?resid=7901919d-7475-443b-b531-9350b2accdb0&cid=312bded3bb6cfc05)

## Вывод
Отчет наглядно показывает сотрудникам, как улучшились показатели в закрепленных за ними товарных группах, а выгрузка на уровне SKU дает возможность подсветить селлерам на площадке зону для роста (улучшение контента, обеспечение непрерывной доступности товара, снижение цен)
